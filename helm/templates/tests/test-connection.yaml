{{/*
AIOps-Platform è¿æ¥æµ‹è¯•
æ–‡ä»¶: test-connection.yaml
æè¿°: Helm Chartéƒ¨ç½²åçš„è¿æ¥æµ‹è¯•é…ç½®
ç‰ˆæœ¬: 1.0.0
ä½œè€…: AIOps Team
*/}}

{{- if .Values.tests.enabled }}
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "aiops.fullname" . }}-test-connection"
  labels:
    {{- include "aiops.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "1"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: connection-test
    image: {{ .Values.tests.image.repository }}:{{ .Values.tests.image.tag }}
    imagePullPolicy: {{ .Values.tests.image.pullPolicy }}
    command:
    - /bin/sh
    - -c
    - |
      set -e
      echo "å¼€å§‹AIOpså¹³å°è¿æ¥æµ‹è¯•..."
      
      # æµ‹è¯•Traefikè¿æ¥
      {{- if .Values.traefik.enabled }}
      echo "æµ‹è¯•Traefikè¿æ¥..."
      wget --spider --timeout=10 --tries=3 http://{{ include "aiops.fullname" . }}-traefik:{{ .Values.traefik.service.port }}/ping || {
        echo "âŒ Traefikè¿æ¥å¤±è´¥"
        exit 1
      }
      echo "âœ… Traefikè¿æ¥æˆåŠŸ"
      {{- end }}
      
      # æµ‹è¯•Prometheusè¿æ¥
      {{- if .Values.prometheus.enabled }}
      echo "æµ‹è¯•Prometheusè¿æ¥..."
      wget --spider --timeout=10 --tries=3 http://{{ include "aiops.fullname" . }}-prometheus:{{ .Values.prometheus.service.port }}/-/healthy || {
        echo "âŒ Prometheusè¿æ¥å¤±è´¥"
        exit 1
      }
      echo "âœ… Prometheusè¿æ¥æˆåŠŸ"
      {{- end }}
      
      # æµ‹è¯•Grafanaè¿æ¥
      {{- if .Values.grafana.enabled }}
      echo "æµ‹è¯•Grafanaè¿æ¥..."
      wget --spider --timeout=10 --tries=3 http://{{ include "aiops.fullname" . }}-grafana:{{ .Values.grafana.service.port }}/api/health || {
        echo "âŒ Grafanaè¿æ¥å¤±è´¥"
        exit 1
      }
      echo "âœ… Grafanaè¿æ¥æˆåŠŸ"
      {{- end }}
      
      # æµ‹è¯•Alertmanagerè¿æ¥
      {{- if .Values.alertmanager.enabled }}
      echo "æµ‹è¯•Alertmanagerè¿æ¥..."
      wget --spider --timeout=10 --tries=3 http://{{ include "aiops.fullname" . }}-alertmanager:{{ .Values.alertmanager.service.port }}/-/healthy || {
        echo "âŒ Alertmanagerè¿æ¥å¤±è´¥"
        exit 1
      }
      echo "âœ… Alertmanagerè¿æ¥æˆåŠŸ"
      {{- end }}
      
      # æµ‹è¯•Elasticsearchè¿æ¥
      {{- if .Values.elasticsearch.enabled }}
      echo "æµ‹è¯•Elasticsearchè¿æ¥..."
      {{- if .Values.elasticsearch.auth.enabled }}
      wget --spider --timeout=10 --tries=3 --user=elastic --password="$(cat /etc/secrets/elasticsearch/password)" http://{{ include "aiops.fullname" . }}-elasticsearch:{{ .Values.elasticsearch.service.port }}/_cluster/health || {
        echo "âŒ Elasticsearchè¿æ¥å¤±è´¥"
        exit 1
      }
      {{- else }}
      wget --spider --timeout=10 --tries=3 http://{{ include "aiops.fullname" . }}-elasticsearch:{{ .Values.elasticsearch.service.port }}/_cluster/health || {
        echo "âŒ Elasticsearchè¿æ¥å¤±è´¥"
        exit 1
      }
      {{- end }}
      echo "âœ… Elasticsearchè¿æ¥æˆåŠŸ"
      {{- end }}
      
      # æµ‹è¯•Kibanaè¿æ¥
      {{- if .Values.kibana.enabled }}
      echo "æµ‹è¯•Kibanaè¿æ¥..."
      wget --spider --timeout=10 --tries=3 http://{{ include "aiops.fullname" . }}-kibana:{{ .Values.kibana.service.port }}/api/status || {
        echo "âŒ Kibanaè¿æ¥å¤±è´¥"
        exit 1
      }
      echo "âœ… Kibanaè¿æ¥æˆåŠŸ"
      {{- end }}
      
      # æµ‹è¯•Redisè¿æ¥
      {{- if .Values.redis.enabled }}
      echo "æµ‹è¯•Redisè¿æ¥..."
      {{- if .Values.redis.auth.enabled }}
      redis-cli -h {{ include "aiops.fullname" . }}-redis -p {{ .Values.redis.service.port }} -a "$(cat /etc/secrets/redis/password)" ping | grep PONG || {
        echo "âŒ Redisè¿æ¥å¤±è´¥"
        exit 1
      }
      {{- else }}
      redis-cli -h {{ include "aiops.fullname" . }}-redis -p {{ .Values.redis.service.port }} ping | grep PONG || {
        echo "âŒ Redisè¿æ¥å¤±è´¥"
        exit 1
      }
      {{- end }}
      echo "âœ… Redisè¿æ¥æˆåŠŸ"
      {{- end }}
      
      # æµ‹è¯•PostgreSQLè¿æ¥
      {{- if .Values.postgresql.enabled }}
      echo "æµ‹è¯•PostgreSQLè¿æ¥..."
      PGPASSWORD="$(cat /etc/secrets/postgresql/password)" pg_isready -h {{ include "aiops.fullname" . }}-postgresql -p {{ .Values.postgresql.service.port }} -U {{ .Values.postgresql.auth.username | default "postgres" }} || {
        echo "âŒ PostgreSQLè¿æ¥å¤±è´¥"
        exit 1
      }
      echo "âœ… PostgreSQLè¿æ¥æˆåŠŸ"
      {{- end }}
      
      # æµ‹è¯•AIå¼•æ“è¿æ¥
      {{- if .Values.aiEngine.enabled }}
      echo "æµ‹è¯•AIå¼•æ“è¿æ¥..."
      wget --spider --timeout=10 --tries=3 http://{{ include "aiops.fullname" . }}-ai-engine:{{ .Values.aiEngine.service.port }}/health || {
        echo "âŒ AIå¼•æ“è¿æ¥å¤±è´¥"
        exit 1
      }
      echo "âœ… AIå¼•æ“è¿æ¥æˆåŠŸ"
      {{- end }}
      
      # æµ‹è¯•APIç½‘å…³è¿æ¥
      {{- if .Values.apiGateway.enabled }}
      echo "æµ‹è¯•APIç½‘å…³è¿æ¥..."
      wget --spider --timeout=10 --tries=3 http://{{ include "aiops.fullname" . }}-api-gateway:{{ .Values.apiGateway.service.port }}/health || {
        echo "âŒ APIç½‘å…³è¿æ¥å¤±è´¥"
        exit 1
      }
      echo "âœ… APIç½‘å…³è¿æ¥æˆåŠŸ"
      {{- end }}
      
      # æµ‹è¯•è‡ªæ„ˆæ‰§è¡Œå™¨è¿æ¥
      {{- if .Values.selfHealing.enabled }}
      echo "æµ‹è¯•è‡ªæ„ˆæ‰§è¡Œå™¨è¿æ¥..."
      wget --spider --timeout=10 --tries=3 http://{{ include "aiops.fullname" . }}-self-healing:{{ .Values.selfHealing.service.port }}/health || {
        echo "âŒ è‡ªæ„ˆæ‰§è¡Œå™¨è¿æ¥å¤±è´¥"
        exit 1
      }
      echo "âœ… è‡ªæ„ˆæ‰§è¡Œå™¨è¿æ¥æˆåŠŸ"
      {{- end }}
      
      echo "ğŸ‰ æ‰€æœ‰è¿æ¥æµ‹è¯•é€šè¿‡ï¼AIOpså¹³å°éƒ¨ç½²æˆåŠŸï¼"
    
    {{- if or .Values.elasticsearch.auth.enabled .Values.redis.auth.enabled .Values.postgresql.enabled }}
    volumeMounts:
    {{- if .Values.elasticsearch.auth.enabled }}
    - name: elasticsearch-auth
      mountPath: /etc/secrets/elasticsearch
      readOnly: true
    {{- end }}
    {{- if .Values.redis.auth.enabled }}
    - name: redis-auth
      mountPath: /etc/secrets/redis
      readOnly: true
    {{- end }}
    {{- if .Values.postgresql.enabled }}
    - name: postgresql-auth
      mountPath: /etc/secrets/postgresql
      readOnly: true
    {{- end }}
    {{- end }}
    
    resources:
      {{- toYaml .Values.tests.resources | nindent 6 }}
  
  {{- if or .Values.elasticsearch.auth.enabled .Values.redis.auth.enabled .Values.postgresql.enabled }}
  volumes:
  {{- if .Values.elasticsearch.auth.enabled }}
  - name: elasticsearch-auth
    secret:
      secretName: {{ include "aiops.fullname" . }}-elasticsearch-auth
  {{- end }}
  {{- if .Values.redis.auth.enabled }}
  - name: redis-auth
    secret:
      secretName: {{ include "aiops.fullname" . }}-redis-auth
  {{- end }}
  {{- if .Values.postgresql.enabled }}
  - name: postgresql-auth
    secret:
      secretName: {{ include "aiops.fullname" . }}-postgresql-auth
  {{- end }}
  {{- end }}
  
  {{- with .Values.tests.nodeSelector }}
  nodeSelector:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  
  {{- with .Values.tests.affinity }}
  affinity:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  
  {{- with .Values.tests.tolerations }}
  tolerations:
    {{- toYaml . | nindent 4 }}
  {{- end }}

---
# APIåŠŸèƒ½æµ‹è¯•
apiVersion: v1
kind: Pod
metadata:
  name: "{{ include "aiops.fullname" . }}-test-api"
  labels:
    {{- include "aiops.labels" . | nindent 4 }}
    app.kubernetes.io/component: test
  annotations:
    "helm.sh/hook": test
    "helm.sh/hook-weight": "2"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  restartPolicy: Never
  containers:
  - name: api-test
    image: {{ .Values.tests.image.repository }}:{{ .Values.tests.image.tag }}
    imagePullPolicy: {{ .Values.tests.image.pullPolicy }}
    command:
    - /bin/sh
    - -c
    - |
      set -e
      echo "å¼€å§‹AIOpså¹³å°APIåŠŸèƒ½æµ‹è¯•..."
      
      {{- if .Values.aiEngine.enabled }}
      # æµ‹è¯•AIå¼•æ“API
      echo "æµ‹è¯•AIå¼•æ“APIåŠŸèƒ½..."
      
      # æµ‹è¯•å¥åº·æ£€æŸ¥
      curl -f -s http://{{ include "aiops.fullname" . }}-ai-engine:{{ .Values.aiEngine.service.port }}/health || {
        echo "âŒ AIå¼•æ“å¥åº·æ£€æŸ¥å¤±è´¥"
        exit 1
      }
      
      # æµ‹è¯•å¼‚å¸¸æ£€æµ‹API
      curl -f -s -X POST \
        -H "Content-Type: application/json" \
        -d '{"metrics": [{"timestamp": "2024-01-01T00:00:00Z", "value": 100, "metric_name": "cpu_usage"}]}' \
        http://{{ include "aiops.fullname" . }}-ai-engine:{{ .Values.aiEngine.service.port }}/api/v1/detect || {
        echo "âŒ AIå¼•æ“å¼‚å¸¸æ£€æµ‹APIæµ‹è¯•å¤±è´¥"
        exit 1
      }
      
      echo "âœ… AIå¼•æ“APIæµ‹è¯•é€šè¿‡"
      {{- end }}
      
      {{- if .Values.apiGateway.enabled }}
      # æµ‹è¯•APIç½‘å…³
      echo "æµ‹è¯•APIç½‘å…³åŠŸèƒ½..."
      
      # æµ‹è¯•å¥åº·æ£€æŸ¥
      curl -f -s http://{{ include "aiops.fullname" . }}-api-gateway:{{ .Values.apiGateway.service.port }}/health || {
        echo "âŒ APIç½‘å…³å¥åº·æ£€æŸ¥å¤±è´¥"
        exit 1
      }
      
      # æµ‹è¯•APIæ–‡æ¡£
      curl -f -s http://{{ include "aiops.fullname" . }}-api-gateway:{{ .Values.apiGateway.service.port }}/docs || {
        echo "âŒ APIç½‘å…³æ–‡æ¡£è®¿é—®å¤±è´¥"
        exit 1
      }
      
      echo "âœ… APIç½‘å…³æµ‹è¯•é€šè¿‡"
      {{- end }}
      
      {{- if .Values.selfHealing.enabled }}
      # æµ‹è¯•è‡ªæ„ˆæ‰§è¡Œå™¨
      echo "æµ‹è¯•è‡ªæ„ˆæ‰§è¡Œå™¨åŠŸèƒ½..."
      
      # æµ‹è¯•å¥åº·æ£€æŸ¥
      curl -f -s http://{{ include "aiops.fullname" . }}-self-healing:{{ .Values.selfHealing.service.port }}/health || {
        echo "âŒ è‡ªæ„ˆæ‰§è¡Œå™¨å¥åº·æ£€æŸ¥å¤±è´¥"
        exit 1
      }
      
      # æµ‹è¯•è§„åˆ™åˆ—è¡¨API
      curl -f -s http://{{ include "aiops.fullname" . }}-self-healing:{{ .Values.selfHealing.service.port }}/api/v1/rules || {
        echo "âŒ è‡ªæ„ˆæ‰§è¡Œå™¨è§„åˆ™APIæµ‹è¯•å¤±è´¥"
        exit 1
      }
      
      echo "âœ… è‡ªæ„ˆæ‰§è¡Œå™¨æµ‹è¯•é€šè¿‡"
      {{- end }}
      
      echo "ğŸ‰ æ‰€æœ‰APIåŠŸèƒ½æµ‹è¯•é€šè¿‡ï¼"
    
    resources:
      {{- toYaml .Values.tests.resources | nindent 6 }}
  
  {{- with .Values.tests.nodeSelector }}
  nodeSelector:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  
  {{- with .Values.tests.affinity }}
  affinity:
    {{- toYaml . | nindent 4 }}
  {{- end }}
  
  {{- with .Values.tests.tolerations }}
  tolerations:
    {{- toYaml . | nindent 4 }}
  {{- end }}

{{- end }}